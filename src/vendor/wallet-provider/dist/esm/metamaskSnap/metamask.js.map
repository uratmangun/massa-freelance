{"version":3,"file":"metamask.js","sourceRoot":"","sources":["../../../src/metamaskSnap/metamask.ts"],"names":[],"mappings":"AAKA,OAAO,EAAE,iBAAiB,EAAE,MAAM,QAAQ,CAAC;AAE3C,MAAM,0BAA0B,GAAG,GAAG,CAAC;AAEvC;;;;;GAKG;AACH,MAAM,CAAC,KAAK,UAAU,eAAe,CACnC,QAAgC;IAEhC,IAAI;QACF,MAAM,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAClC,OAAO,IAAI,CAAC;KACb;IAAC,MAAM;QACN,OAAO,KAAK,CAAC;KACd;AACH,CAAC;AAED,SAAS,kBAAkB,CAAC,GAAY;IACtC,OAAO,CACL,GAAG,KAAK,IAAI;QACZ,OAAO,GAAG,KAAK,QAAQ;QACvB,iDAAiD;QACjD,GAAG,CAAC,cAAc,CAAC,YAAY,CAAC;QAChC,iDAAiD;QACjD,GAAG,CAAC,cAAc,CAAC,SAAS,CAAC,CAC9B,CAAC;AACJ,CAAC;AAED;;;;GAIG;AACH,MAAM,CAAC,KAAK,UAAU,0BAA0B;IAC9C,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;QAC7B,MAAM,OAAO,GAAG,UAAU,CAAC,GAAG,EAAE;YAC9B,OAAO,EAAE,CAAC;YACV,OAAO,CAAC,IAAI,CAAC,CAAC;QAChB,CAAC,EAAE,0BAA0B,CAAC,CAAC;QAE/B,SAAS,OAAO;YACd,IAAI,OAAO,MAAM,CAAC,mBAAmB,KAAK,UAAU,EAAE;gBACpD,MAAM,CAAC,mBAAmB,CACxB,0BAA0B,EAC1B,kBAAkB,CACnB,CAAC;aACH;YACD,YAAY,CAAC,OAAO,CAAC,CAAC;QACxB,CAAC;QAED,SAAS,kBAAkB,CAAC,EAAE,MAAM,EAAgC;YAClE,IACE,CAAC,aAAa,EAAE,mBAAmB,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC;gBAC/D,kBAAkB,CAAC,MAAM,CAAC,QAAQ,CAAC,EACnC;gBACA,OAAO,EAAE,CAAC;gBACV,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;aAC1B;QACH,CAAC;QAED,IAAI,OAAO,MAAM,CAAC,gBAAgB,KAAK,UAAU,EAAE;YACjD,MAAM,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,kBAAkB,CAAC,CAAC;SACzE;QACD,IAAI,OAAO,MAAM,CAAC,aAAa,KAAK,UAAU,EAAE;YAC9C,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC,CAAC;SAC5D;IACH,CAAC,CAAC,CAAC;AACL,CAAC;AAED;;;;GAIG;AACH,MAAM,CAAC,KAAK,UAAU,mBAAmB;IACvC,MAAM,eAAe,GAAG,MAAM,0BAA0B,EAAE,CAAC;IAC3D,IAAI,eAAe,IAAI,CAAC,MAAM,eAAe,CAAC,eAAe,CAAC,CAAC,EAAE;QAC/D,OAAO,eAAe,CAAC;KACxB;IAED,OAAO,IAAI,CAAC;AACd,CAAC","sourcesContent":["import type {\n  EIP6963AnnounceProviderEvent,\n  MetaMaskInpageProvider,\n} from '@metamask/providers';\nimport { MetaMaskProvider } from './types/snap';\nimport { getInstalledSnaps } from './snap';\n\nconst PROVIDER_DETECTION_TIMEOUT = 500;\n\n/**\n * Check if a provider supports snaps by calling `wallet_getSnaps`.\n *\n * @param provider - The provider to test for snaps support\n * @returns A promise that resolves to true if snaps are supported\n */\nexport async function hasSnapsSupport(\n  provider: MetaMaskInpageProvider,\n): Promise<boolean> {\n  try {\n    await getInstalledSnaps(provider);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction isMetaMaskProvider(obj: unknown): obj is MetaMaskProvider {\n  return (\n    obj !== null &&\n    typeof obj === 'object' &&\n    // eslint-disable-next-line no-prototype-builtins\n    obj.hasOwnProperty('isMetaMask') &&\n    // eslint-disable-next-line no-prototype-builtins\n    obj.hasOwnProperty('request')\n  );\n}\n\n/**\n * Get a MetaMask provider using EIP6963 specification.\n *\n * @returns Promise resolving to MetaMask provider or null if not found within timeout\n */\nexport async function getMetaMaskEIP6963Provider(): Promise<MetaMaskInpageProvider | null> {\n  return new Promise((resolve) => {\n    const timeout = setTimeout(() => {\n      cleanup();\n      resolve(null);\n    }, PROVIDER_DETECTION_TIMEOUT);\n\n    function cleanup() {\n      if (typeof window.removeEventListener === 'function') {\n        window.removeEventListener(\n          'eip6963:announceProvider',\n          handleAnnouncement,\n        );\n      }\n      clearTimeout(timeout);\n    }\n\n    function handleAnnouncement({ detail }: EIP6963AnnounceProviderEvent) {\n      if (\n        ['io.metamask', 'io.metamask.flask'].includes(detail.info.rdns) &&\n        isMetaMaskProvider(detail.provider)\n      ) {\n        cleanup();\n        resolve(detail.provider);\n      }\n    }\n\n    if (typeof window.addEventListener === 'function') {\n      window.addEventListener('eip6963:announceProvider', handleAnnouncement);\n    }\n    if (typeof window.dispatchEvent === 'function') {\n      window.dispatchEvent(new Event('eip6963:requestProvider'));\n    }\n  });\n}\n\n/**\n * Get a MetaMask provider that supports snaps.\n *\n * @returns Promise resolving to a compatible provider or null\n */\nexport async function getMetamaskProvider(): Promise<MetaMaskInpageProvider | null> {\n  const eip6963Provider = await getMetaMaskEIP6963Provider();\n  if (eip6963Provider && (await hasSnapsSupport(eip6963Provider))) {\n    return eip6963Provider;\n  }\n\n  return null;\n}\n"]}