{"version":3,"file":"MassaStationWallet.js","sourceRoot":"","sources":["../../../src/massaStation/MassaStationWallet.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  deleteRequest,\n  getRequest,\n  postRequest,\n  putRequest,\n} from './RequestHandler';\nimport { MassaStationAccount } from './MassaStationAccount';\nimport {\n  AddUpdateSignRuleResponse,\n  Config,\n  MassaStationAccountStatus,\n  MSAccount,\n  MSAccountsResp,\n  SignRule,\n} from './types';\nimport { EventEmitter } from 'eventemitter3';\nimport { Wallet } from '../wallet/interface';\nimport { Network } from '@massalabs/massa-web3';\nimport { networkInfos } from './utils/network';\nimport { WalletName } from '../wallet';\nimport { isMassaWalletEnabled } from './MassaStationDiscovery';\nimport { isStandalone } from './utils/standalone';\n\n/**\n * MassaStation url\n */\nexport const MASSA_STATION_URL = 'https://station.massa/';\n\n/**\n * The MassaStation accounts url\n */\n\nexport function walletApiUrl(): string {\n  // This is a hack to detect that MS wallet is working in standalone mode\n  if (isStandalone()) {\n    return `http://localhost:8080/api`;\n  }\n  return `${MASSA_STATION_URL}plugin/massa-labs/massa-wallet/api`;\n}\n/**\n * Events emitted by MassaStation\n */\nconst MASSA_STATION_NETWORK_CHANGED = 'MASSA_STATION_NETWORK_CHANGED';\n\n/**\n * This class provides an implementation for communicating with the MassaStation wallet.\n * @remarks\n * This class is used as a proxy to the MassaStation server for exchanging message over https calls.\n */\nexport class MassaStationWallet implements Wallet {\n  private walletName = WalletName.MassaWallet;\n\n  private eventsListener = new EventEmitter();\n  private currentNetwork: Network;\n\n  public name(): WalletName {\n    return this.walletName;\n  }\n\n  static async createIfInstalled(): Promise<Wallet | null> {\n    if (isStandalone() || (await isMassaWalletEnabled())) {\n      return new MassaStationWallet();\n    }\n    return null;\n  }\n\n  public async accounts(): Promise<MassaStationAccount[]> {\n    const res = await getRequest<MSAccountsResp>(walletApiUrl() + '/accounts');\n\n    return res.result\n      .filter((account) => {\n        return account.status === MassaStationAccountStatus.OK;\n      })\n      .map((account) => {\n        return new MassaStationAccount(account.address, account.nickname);\n      });\n  }\n\n  public async importAccount(\n    publicKey: string,\n    privateKey: string,\n  ): Promise<void> {\n    await putRequest(walletApiUrl() + '/accounts', {\n      publicKey,\n      privateKey,\n    });\n  }\n\n  public async deleteAccount(address: string): Promise<void> {\n    // get all accounts and find the account to delete\n    const allAccounts = await getRequest<MSAccountsResp>(\n      walletApiUrl() + '/accounts',\n    );\n\n    const accountToDelete = allAccounts.result.find(\n      (account) => account.address === address,\n    );\n\n    if (!accountToDelete) {\n      throw new Error('Account not found');\n    }\n\n    await deleteRequest<unknown>(\n      `${walletApiUrl()}/accounts/${accountToDelete.nickname}`,\n    );\n  }\n\n  public async networkInfos(): Promise<Network> {\n    return networkInfos();\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  public async setRpcUrl(url: string): Promise<void> {\n    throw new Error(\n      'setRpcUrl is not yet implemented for the current provider.',\n    );\n  }\n\n  /**\n   * This method sends an http call to the MassaStation server to create a new random account.\n   *\n   * @returns a Promise that resolves to the details of the newly generated account.\n   */\n  public async generateNewAccount(name: string): Promise<MassaStationAccount> {\n    const response = await postRequest<MSAccount>(\n      walletApiUrl() + '/accounts/' + name,\n      {},\n    );\n\n    return new MassaStationAccount(\n      response.result.address,\n      response.result.nickname,\n    );\n  }\n\n  public listenAccountChanges(): { unsubscribe: () => void } | undefined {\n    throw new Error(\n      'listenAccountChanges is not yet implemented for the current provider.',\n    );\n  }\n\n  public listenNetworkChanges(\n    callback: (network: Network) => void,\n  ): { unsubscribe: () => void } | undefined {\n    this.eventsListener.on(MASSA_STATION_NETWORK_CHANGED, (evt) =>\n      callback(evt),\n    );\n\n    // check periodically if network changed\n    const intervalId = setInterval(async () => {\n      const network = await this.networkInfos();\n      if (!this.currentNetwork) {\n        this.currentNetwork = network;\n        return;\n      }\n      if (this.currentNetwork.name !== network.name) {\n        this.currentNetwork = network;\n        this.eventsListener.emit(MASSA_STATION_NETWORK_CHANGED, network);\n      }\n    }, 500);\n\n    return {\n      unsubscribe: () => {\n        clearInterval(intervalId);\n        this.eventsListener.removeListener(\n          MASSA_STATION_NETWORK_CHANGED,\n          // eslint-disable-next-line @typescript-eslint/no-empty-function\n          () => {},\n        );\n      },\n    };\n  }\n\n  /**\n   * Simulates connecting to the station.\n   * This method always returns `true` because the station is inherently connected.\n   */\n  public async connect(): Promise<boolean> {\n    return true;\n  }\n\n  /**\n   * Simulates disconnecting from the station.\n   * This method always returns `true` because the station cannot be disconnected.\n   */\n  public async disconnect(): Promise<boolean> {\n    return true;\n  }\n\n  /**\n   * Indicates if the station is connected.\n   * Always returns `true` because the station is always connected when running.\n   */\n  public async connected(): Promise<boolean> {\n    return true;\n  }\n\n  /**\n   * Indicates if the station is enabled.\n   * Always returns `true` because the station is always enabled by default.\n   */\n  public enabled(): boolean {\n    return true;\n  }\n  /**\n   * Retrieves the configuration from the MS Wallet api.\n   *\n   * @returns The configuration of MS wallet.\n   */\n  public async getConfig(): Promise<Config> {\n    const { result } = await getRequest<Config>(walletApiUrl() + '/config');\n    return result;\n  }\n\n  /**\n   * Adds a new signing rule to the MassaStation wallet.\n   *\n   * @param accountName - The name of the account.\n   * @param rule - The signing rule to add.\n   * @param desc - Custom description of the new rule creation.\n   * @returns A Promise that resolves when the rule is successfully added.\n   */\n  public async addSignRule(\n    accountName: string,\n    rule: SignRule,\n    desc?: string,\n  ): Promise<AddUpdateSignRuleResponse> {\n    const { result } = await postRequest<AddUpdateSignRuleResponse>(\n      walletApiUrl() + '/accounts/' + accountName + '/signrules',\n      {\n        description: desc,\n        name: rule.name,\n        ruleType: rule.ruleType,\n        contract: rule.contract,\n        enabled: rule.enabled,\n        authorizedOrigin: rule.authorizedOrigin,\n      },\n    );\n    return result;\n  }\n\n  /**\n   * Edits an existing signing rule in the MassaStation wallet.\n   * Modifying the contract or ruleType will result in a new rule being created with a new Id.\n   *\n   * @param accountName - The name of the account.\n   * @param rule - The updated signing rule.\n   * @param desc - Custom description of the rule update.\n   * @returns A Promise that resolves when the rule is successfully edited.\n   */\n  public async editSignRule(\n    accountName: string,\n    rule: SignRule,\n    desc?: string,\n  ): Promise<AddUpdateSignRuleResponse> {\n    const { result } = await putRequest<AddUpdateSignRuleResponse>(\n      walletApiUrl() + '/accounts/' + accountName + '/signrules/' + rule.id,\n      {\n        description: desc,\n        name: rule.name,\n        ruleType: rule.ruleType,\n        contract: rule.contract,\n        enabled: rule.enabled,\n      },\n    );\n\n    return result;\n  }\n\n  /**\n   * Deletes a signing rule from the MassaStation wallet.\n   *\n   * @param accountName - The name of the account.\n   * @param ruleId - The Id of the sign rule.\n   * @returns A Promise that resolves when the rule is successfully deleted.\n   */\n  public async deleteSignRule(\n    accountName: string,\n    ruleId: string,\n  ): Promise<void> {\n    await deleteRequest(\n      walletApiUrl() + '/accounts/' + accountName + '/signrules/' + ruleId,\n    );\n  }\n}\n"]}